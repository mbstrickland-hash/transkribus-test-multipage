<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Document Viewer</title>

<style>
body { margin: 0; font-family: system-ui, Arial, sans-serif; }

.wrap{
  display: grid;
  grid-template-columns: 3fr 2fr;
  gap: 16px;
  padding: 16px;
}

.panel{
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 12px;
  background: #fff;
  height: 60vh;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.topControls{
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  font-size: 14px;
}

select, .btn{
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #f7f7f7;
}

.btn:disabled{ opacity: 0.5; }

.imgBox{
  position: relative;
  flex: 1;
  overflow: auto;
  border-radius: 10px;
  cursor: grab;
}
.imgBox.dragging{ cursor: grabbing; }

img{
  display: block;
  width: 100%;
  transform-origin: top left;
}

.overlay{
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
  transform-origin: top left;
}

#linePane{
  flex: 1;
  overflow: auto;
}

.line{
  padding: 6px 8px;
  margin: 4px 0;
  border-radius: 8px;
  cursor: pointer;
}
.line:hover{ background: #f2f2f2; }
.line.active{ background: #ffeaa7; }

.hl{
  fill: rgba(255,234,167,.35);
  stroke: rgba(0,0,0,.35);
  stroke-width: 2;
}
.hl.active{
  fill: rgba(255,234,167,.65);
  stroke: rgba(0,0,0,.6);
}
</style>
</head>

<body>
<div class="wrap">

<div class="panel">
  <div class="topControls">
    Page:
    <select id="pageSelect"></select>
    <button class="btn" id="prev">◀</button>
    <button class="btn" id="next">▶</button>
    <span id="indicator"></span>
    Zoom:
    <input id="zoom" type="range" min="1" max="2.5" step="0.05" value="1.25">
  </div>

  <div class="imgBox" id="imgBox">
    <img id="img">
    <svg class="overlay" id="svg"></svg>
  </div>
</div>

<div class="panel">
  <div id="linePane"></div>
</div>

</div>

<script>
(async()=>{
const PAGES=[
 {label:"Page 1",image:"p001.jpg",xml:"p001.xml"},
 {label:"Page 2",image:"p002.jpg",xml:"p002.xml"},
 {label:"Page 3",image:"p003.jpg",xml:"p003.xml"}
];

const imgBox=imgBox=document.getElementById("imgBox");
const img=document.getElementById("img");
const svg=document.getElementById("svg");
const lines=document.getElementById("linePane");
const zoomInput=document.getElementById("zoom");
const pageSelect=document.getElementById("pageSelect");
const indicator=document.getElementById("indicator");

let zoom=parseFloat(zoomInput.value);
let page=0;
let imgW=1,imgH=1;

/* ---------- zoom & pan ---------- */
function applyZoom(z){
 zoom=z;
 img.style.transform=`scale(${z})`;
 svg.style.transform=`scale(${z})`;
}
zoomInput.oninput=()=>applyZoom(+zoomInput.value);

imgBox.addEventListener("wheel",e=>{
 e.preventDefault();
 applyZoom(Math.min(2.5,Math.max(1,zoom+(e.deltaY<0?.1:-.1))));
},{passive:false});

let drag=false,sx,sy,sl,st;
imgBox.onmousedown=e=>{
 drag=true; sx=e.clientX; sy=e.clientY;
 sl=imgBox.scrollLeft; st=imgBox.scrollTop;
 imgBox.classList.add("dragging");
};
window.onmousemove=e=>{
 if(!drag)return;
 imgBox.scrollLeft=sl-(e.clientX-sx);
 imgBox.scrollTop =st-(e.clientY-sy);
};
window.onmouseup=()=>{drag=false;imgBox.classList.remove("dragging");};

/* ---------- helpers ---------- */
function bbox(pts){
 let xs=[],ys=[];
 pts.split(" ").forEach(p=>{
  let [x,y]=p.split(",").map(Number);
  xs.push(x); ys.push(y);
 });
 return {
  cx:(Math.min(...xs)+Math.max(...xs))/2,
  cy:(Math.min(...ys)+Math.max(...ys))/2
 };
}

function scrollImageTo(id){
 const poly=svg.querySelector(`[data-id="${id}"]`);
 if(!poly)return;
 const b=bbox(poly.getAttribute("points"));
 const scaleX=(img.clientWidth/zoom)/imgW;
 const scaleY=(img.clientHeight/zoom)/imgH;
 imgBox.scrollLeft=b.cx*scaleX*zoom-imgBox.clientWidth/2;
 imgBox.scrollTop =b.cy*scaleY*zoom-imgBox.clientHeight/2;
}

function scrollTextTo(id){
 const el=lines.querySelector(`[data-id="${id}"]`);
 if(el) el.scrollIntoView({block:"center"});
}

function setActive(id){
 document.querySelectorAll(".active").forEach(x=>x.classList.remove("active"));
 lines.querySelector(`[data-id="${id}"]`)?.classList.add("active");
 svg.querySelector(`[data-id="${id}"]`)?.classList.add("active");
}

/* ---------- load page ---------- */
async function load(i){
 page=Math.max(0,Math.min(PAGES.length-1,i));
 pageSelect.value=page;
 indicator.textContent=`Page ${page+1} of ${PAGES.length}`;
 lines.innerHTML=""; svg.innerHTML="";
 img.src=PAGES[page].image;

 const xml=await fetch(PAGES[page].xml).then(r=>r.text());
 const doc=new DOMParser().parseFromString(xml,"application/xml");
 const pg=doc.querySelector("Page");
 imgW=+pg.getAttribute("imageWidth");
 imgH=+pg.getAttribute("imageHeight");
 svg.setAttribute("viewBox",`0 0 ${imgW} ${imgH}`);

 doc.querySelectorAll("TextLine").forEach(t=>{
  const id=t.getAttribute("id");
  const pts=t.querySelector("Coords")?.getAttribute("points");
  const txt=t.querySelector("Unicode")?.textContent;
  if(!pts||!txt)return;

  const div=document.createElement("div");
  div.className="line";
  div.dataset.id=id;
  div.textContent=txt;
  div.onclick=()=>{setActive(id);scrollImageTo(id);};
  lines.appendChild(div);

  const poly=document.createElementNS("http://www.w3.org/2000/svg","polygon");
  poly.setAttribute("points",pts);
  poly.dataset.id=id;
  poly.classList.add("hl");
  poly.style.pointerEvents="auto";
  poly.onclick=()=>{setActive(id);scrollTextTo(id);};
  svg.appendChild(poly);
 });

 applyZoom(zoom);
}

/* ---------- init ---------- */
PAGES.forEach((p,i)=>{
 const o=document.createElement("option");
 o.value=i;o.textContent=p.label;
 pageSelect.appendChild(o);
});
pageSelect.onchange=()=>load(+pageSelect.value);
prev.onclick=()=>load(page-1);
next.onclick=()=>load(page+1);
await load(0);
})();
</script>
</body>
</html>
